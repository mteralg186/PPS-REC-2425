
<%- include('partes/headera') %>

<div class="container mt-5">
  <h2 class="text-center mb-4"><%= title %></h2>

  <!-- Filtro por clase -->
  <form id="formFiltro" class="mb-4 d-flex gap-2 align-items-center justify-content-center" onsubmit="return false;">
    <label for="id_clase">Filtrar por clase:</label>
    <select name="id_clase" id="id_clase" class="form-select w-auto">
      <option value="">Todas las clases</option>
      <% clasesParaFiltro.forEach(clase => { %>
        <option value="<%= clase.id_clase %>" <%= clase.id_clase == idClaseFiltro ? 'selected' : '' %>>
          <%= clase.nombre %>
        </option>
      <% }) %>
    </select>
    <button id="btnFiltrar" class="btn btn-primary" type="button">Filtrar</button>
  </form>

  <% if (mensaje) { %>
    <div class="alert alert-danger text-center"><%= mensaje %></div>
  <% } %>

  <% if (clasesAsignadas.length === 0) { %>
    <p class="text-center text-muted">No tienes clases asignadas para este filtro.</p>
  <% } else { %>
    <div class="list-group">
      <% clasesAsignadas.forEach(clase => { %>
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <h5><%= clase.nombre_clase %> (<%= clase.codigo %>)</h5>
            <small>Asignada el: <%= new Date(clase.fecha_asignacion).toLocaleString() %></small>
          </div>
          <button class="btn btn-danger btn-sm btnEliminar" data-id="<%= clase.id %>">Eliminar</button>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<!-- Modal Bootstrap de confirmación -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalEliminarLabel">Confirmar eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro que deseas eliminar esta asignación? Esta acción no se puede deshacer.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmarEliminarBtn">Sí, eliminar</button>
      </div>
    </div>
  </div>
</div>

<script>
  const btnFiltrar = document.getElementById('btnFiltrar');
  const selectClase = document.getElementById('id_clase');

  btnFiltrar.addEventListener('click', () => {
    const filtro = selectClase.value;
    const url = new URL(window.location.href);
    if (filtro) {
      url.searchParams.set('id_clase', filtro);
    } else {
      url.searchParams.delete('id_clase');
    }
    window.location.href = url.toString();
  });

  let idParaEliminar = null;
  const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminar'));
  const confirmarBtn = document.getElementById('confirmarEliminarBtn');

  document.querySelectorAll('.btnEliminar').forEach(btn => {
    btn.addEventListener('click', () => {
      idParaEliminar = btn.getAttribute('data-id');
      modal.show();
    });
  });

  confirmarBtn.addEventListener('click', async () => {
    if (!idParaEliminar) return;

    try {
      const res = await fetch(`/alumno/clases-asignadas/${idParaEliminar}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();

      if (res.ok) {
        modal.hide();
        alert(data.mensaje);
        window.location.reload();
      } else {
        alert(data.mensaje || 'No se pudo eliminar la asignación.');
      }
    } catch {
      alert('Error de conexión. Inténtalo nuevamente.');
    }
  });
</script>

<%- include('partes/footer') %>
